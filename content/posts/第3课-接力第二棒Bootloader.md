+++
author = "FanHe"
title = "第3课 接力第二棒Bootloader"
date = 2022-04-18T13:53:28+08:00
description = ""
categories = [
 "从零打造操作系统"
]
draft = false
+++

## 

## 1. 概述

本文开始从MBR进入到第二棒Bootloader，为操作系统的加载做准备

## 2. Bootloader

操作系统开发中第一棒是从BIOS进入到MBR，在MBR中只有短短的512字节，并且里面真正的代码部分只有460字节，这对于一个操作系统的加载来说是远远不够的，于是我们需要从MBR中将控制权进一步转交给下一个新的步骤：也就是传递给Bootloader，之后Bootloader可以做一些设置和执行必要的代码，最终真正的将操作系统装载到内存中

那么Bootloader在什么地方呢？很显然Bootloader应该是存在于磁盘中的，然后通过MBR将Bootloader读取内存中

## 3.  磁盘操作

在准备磁盘操作时，需要简要的认识一下磁盘，磁盘（主要是老式的机械硬盘）的结构图如下

![磁盘结构](/img/osdev/disk.png)

磁盘通过主轴的旋转带动盘片旋转，加上磁头臂的来回移动（带动磁头运动），可以实现让磁头在磁道上移动，从而实现读写数据

磁盘读写的细节非常繁多，在此就不进行赘述了。（其实我们完全可以利用IVT中提供的中断例程来读写磁盘）

## 4. 选择加载位置

通过观察之前的1MB内存的布局，我们决定把bootloader的文件读取后存放在 0x900内存开始处（此值是随意选的，只要满足有足够的空间即可），经过设置之后的内存布局如下图所示：

<img src="/img/osdev/boot-loader.png" title="" alt="Bootloader内存位置" data-align="center">

整个过程可以描述如下：

（1）BIOS读取磁盘第1个扇区内容并将512字节的MBR拷贝到内存0x7C00处

（2）MBR代码读取磁盘第2个扇区内容，并将loader拷贝到内存0x900处

（3）拷贝完成之后，MBR调用jmp指令跳转到0x900处继续执行loader中的代码
